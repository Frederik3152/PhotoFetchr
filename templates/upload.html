{% extends "base.html" %}

{% block title %}Upload - PhotoFetchr{% endblock %}

{% block content %}
<div class="container">
    <div class="upload-header">
        <div class="breadcrumb">
            <a href="{{ url_for('homepage') }}" class="breadcrumb-btn">Home</a>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span>Upload Photos</span>
        </div>
        <h2>Upload Photos</h2>
        <p>Add new photos to your collection with metadata</p>
    </div>

    <!-- Upload Form -->
    <form id="upload-form" method="POST" enctype="multipart/form-data" action="{{ url_for('upload') }}">

        <!-- File Upload Area -->
        <div class="upload-section">
            <div class="upload-area" id="upload-area">
                <div class="upload-content">
                    <div class="upload-icon">üì§</div>
                    <h3>Drag & Drop Photos Here</h3>
                    <p>or <button type="button" class="upload-browse" id="browse-files">browse files</button></p>
                    <input type="file" name="photos" id="file-input" multiple accept="image/jpeg,image/png,image/gif,image/webp" hidden>
                    <div class="upload-info">
                        <small>Supports: JPG, JPEG, PNG, WEBP</small>
                    </div>
                </div>
            </div>

            <!-- Selected Files Preview -->
            <div class="upload-queue" id="upload-queue" style="display: none;">
                <h4>Selected Files</h4>
                <div class="file-list" id="file-list">
                    <!-- File items will appear here -->
                </div>
            </div>
        </div>

        <!-- Metadata Section -->
        <div class="metadata-section">
            <h4>Photo Information</h4>

            <div class="form-row">
                <div class="form-group">
                    <label for="country" class="form-label">Country *</label>
                    <select name="country" id="country" class="form-control" required>
                        <option value="">Select Country</option>
                        {% for country in countries %}
                        <option value="{{ country }}">{{ country }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="date" class="form-label">Date Taken (Optional)</label>
                    <input type="date" name="date" id="date" class="form-control">
                    <small class="form-help">Leave empty to use current date</small>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">People in Photos (Optional)</label>
                <div class="people-selection">
                    <div class="people-search">
                        <input type="text" class="form-control" placeholder="Search people..." id="people-search">
                    </div>
                    <div class="people-grid">
                        {% for person in people %}
                        <label class="person-checkbox">
                            <input type="checkbox" name="people" value="{{ person[0] if person is sequence else person }}">
                            <span class="checkbox-label">{{ person[0] if person is sequence else person }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Actions -->
        <div class="upload-actions">
            <button type="button" class="btn btn--outline" id="clear-files">Clear Files</button>
            <button type="submit" class="btn btn--primary" id="upload-btn" disabled>
                <span class="btn-text">Upload Photos</span>
                <span class="btn-loader" style="display: none;">‚è≥ Uploading...</span>
            </button>
        </div>
    </form>

    <!-- Results Section -->
    <div class="results-section" id="results-section" style="display: none;">
        <h4>Upload Results</h4>
        <div class="results-list" id="results-list">
            <!-- Results will appear here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Upload functionality with Python backend integration
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-files');
    const uploadArea = document.getElementById('upload-area');
    const uploadQueue = document.getElementById('upload-queue');
    const fileList = document.getElementById('file-list');
    const uploadForm = document.getElementById('upload-form');
    const uploadBtn = document.getElementById('upload-btn');
    const clearBtn = document.getElementById('clear-files');
    const peopleSearch = document.getElementById('people-search');
    const resultsSection = document.getElementById('results-section');
    const resultsList = document.getElementById('results-list');

    let selectedFiles = [];

    // Browse files button
    browseBtn.addEventListener('click', () => {
        fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        handleFiles(Array.from(e.target.files));
    });

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(file => 
            file.type.startsWith('image/')
        );
        handleFiles(files);
    });

    // Handle file selection
    function handleFiles(files) {
        files.forEach(file => {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                return;
            }

            if (!selectedFiles.find(f => f.name === file.name)) {
                selectedFiles.push(file);
            }
        });

        updateFileList();
        updateUploadButton();
    }

    // Update file list display
    function updateFileList() {
        if (selectedFiles.length === 0) {
            uploadQueue.style.display = 'none';
            return;
        }

        uploadQueue.style.display = 'block';
        fileList.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                </div>
                <button type="button" class="file-remove" onclick="removeFile(${index})">Remove</button>
            `;
            fileList.appendChild(fileItem);
        });
    }

    // Remove file
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        updateUploadButton();
    }

    // Clear all files
    clearBtn.addEventListener('click', () => {
        selectedFiles = [];
        fileInput.value = '';
        updateFileList();
        updateUploadButton();
        resultsSection.style.display = 'none';
    });

    // Update upload button state
    function updateUploadButton() {
        uploadBtn.disabled = selectedFiles.length === 0;
    }

    // People search functionality
    peopleSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const checkboxes = document.querySelectorAll('.person-checkbox');

        checkboxes.forEach(checkbox => {
            const label = checkbox.querySelector('.checkbox-label').textContent.toLowerCase();
            if (label.includes(searchTerm)) {
                checkbox.style.display = 'flex';
            } else {
                checkbox.style.display = 'none';
            }
        });
    });

    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        if (selectedFiles.length === 0) {
            alert('Please select files to upload.');
            return;
        }

        const country = document.getElementById('country').value;
        if (!country) {
            alert('Please select a country.');
            return;
        }

        // Show loading state
        const btnText = uploadBtn.querySelector('.btn-text');
        const btnLoader = uploadBtn.querySelector('.btn-loader');
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline';
        uploadBtn.disabled = true;

        // Create FormData
        const formData = new FormData();

        // Add files
        selectedFiles.forEach(file => {
            formData.append('photos', file);
        });

        // Add metadata
        formData.append('country', country);

        const date = document.getElementById('date').value;
        if (date) {
            formData.append('date', date);
        }

        // Add selected people
        const selectedPeople = Array.from(document.querySelectorAll('input[name="people"]:checked'))
            .map(cb => cb.value);
        selectedPeople.forEach(person => {
            formData.append('people', person);
        });

        // Submit to Flask backend
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data);

            // Reset form on success
            const hasSuccess = data.some(result => result.success);
            if (hasSuccess) {
                selectedFiles = [];
                fileInput.value = '';
                updateFileList();
                uploadForm.reset();
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            displayResults([{
                success: false,
                filename: 'Upload Error',
                error: 'Connection error occurred'
            }]);
        })
        .finally(() => {
            // Reset button state
            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';
            updateUploadButton();
        });
    });

    // Display upload results
    function displayResults(results) {
        resultsSection.style.display = 'block';
        resultsList.innerHTML = '';

        results.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${result.success ? 'success' : 'error'}`;

            if (result.success) {
                resultItem.innerHTML = `
                    <span>‚úì</span>
                    <div>
                        <strong>${result.filename}</strong> uploaded successfully
                        <br><small>ID: ${result.id} | Date: ${result.date}</small>
                    </div>
                `;
            } else {
                resultItem.innerHTML = `
                    <span>‚úó</span>
                    <div>
                        <strong>${result.filename}</strong> failed
                        <br><small>${result.error}</small>
                    </div>
                `;
            }

            resultsList.appendChild(resultItem);
        });

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Utility function
    function formatFileSize(bytes) {
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        if (bytes === 0) return '0 Bytes';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }
});
</script>
{% endblock %}